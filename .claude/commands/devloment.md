Command name: development-backend-python-fastapi

Command usage:
/clear
/development-backend-python-fastapi Tech design is in tech-design.md
/cost

Command details:

You are a Senior Python Developer and Solution Architect with 10+ years of experience in enterprise application development.

Please use the following Tech Design as a reference for your development: $TECH_DESIGN

## Technical Stack
### Core Technologies

- **Python**: 3.10+

- **Framework**: FastAPI, Pydantic

- **Build Tool**: Poetry

- **Database**: PostgreSQL

- **Messaging**: Kafka

- **Testing**: Pytest

- **CI/CD Tools**: Docker, Docker Compose, pre-commit, Makefile

- **Documentation**: OpenAPI 3.0 (auto-generated by FastAPI)

## Development Methodology
### TDD Approach (Mandatory)

Follow the Red-Green-Refactor cycle:

1. **ğŸ”´ RED**: Write failing pytest tests for business logic first (e.g., for CIBIL simulation, decision logic, API endpoints).
2. **ğŸŸ¢ GREEN**: Implement the minimum code (FastAPI endpoint, service logic) to make the tests pass.
3. **ğŸ”„ REFACTOR**: Improve the code design (e.g., abstracting business logic) while keeping tests green.
4. **ğŸ”— INTEGRATE**: Add integration tests (e.g., testing API-to-Kafka, consumer-to-DB flow) using docker-compose.
5. **ğŸ“Š COVERAGE**: Ensure 85%+ test coverage.

## Architecture Patterns
### Event-Driven Microservices
## Architecture Patterns

### Event-Driven Microservices

```text
prequal-api (FastAPI)
        â”‚
        â–¼
   Database (PostgreSQL)
        â”‚
        â–¼
   Kafka Broker
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ loan_applications_submitted â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
credit-service (Kafka Consumer)
        â”‚
        â–¼
   Kafka Broker
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ credit_reports_generated â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
decision-service (Kafka Consumer)
        â”‚
        â–¼
   Database (PostgreSQL)

```


## **The system consists of three independent services, a database, and a message broker**:
1. **prequal-api (FastAPI)**: Handles user requests, validates data, saves to DB, and publishes to Kafka .
2. **credit-service (Kafka Consumer)**: Consumes from loan_applications_submitted, simulates CIBIL score, and publishes to credit_reports_generated .
3. **decision-service (Kafka Consumer)**: Consumes from credit_reports_generated, applies business rules, and updates the DB .

## Key Components

1. **Pydantic Models**: Used for API request/response validation and Kafka message schemas.
2. **FastAPI Dependencies**: Used for managing database sessions and other shared logic.
3. **Exception Handling**: Custom exception handlers in FastAPI for 4xx/5xx responses.
4. **Business Logic**: Decoupled from the API/consumer logic into separate service modules.

## Implementation Requirements
### REST API Standards (for prequal-api)

- âœ… Proper HTTP status codes (e.g., 202 Accepted, 200 OK, 422 Unprocessable Entity).

- âœ… Input validation using FastAPI's automatic Pydantic validation.

- âœ… Global exception handling for consistent error responses.

- âœ… Structured logging with correlation IDs (e.g., application_id).

#### Infrastructure

- âœ… Database connection pooling (e.g., using SQLAlchemy).

- âœ… A /health endpoint for health monitoring.

- âœ… docker-compose.yml to orchestrate all services (3 Python apps, Kafka, PostgreSQL).

- âœ… Makefile for simple commands (lint, test, run-local).

## Testing Strategy

### Test Types & Approaches

| Test Type | Framework | Purpose |
|-----------|-----------|---------|
| **Unit Tests** | pytest + mock | Test credit-service CIBIL logic & decision-service rules in isolation |
| **API Tests** | pytest + TestClient | Test prequal-api endpoints (status codes, responses, validation) |
| **Integration Tests** | pytest + docker-compose | Test service-to-broker (Kafka) and service-to-DB (PostgreSQL) interactions |
| **E2E Tests** | pytest | Submit an app via POST, poll the GET status endpoint, and verify the final status in the DB |

## Quality Gates
### Code Quality Requirements

- âœ… pre-commit hooks must pass.
- âœ… Ruff for linting.
- âœ… Black for formatting.
- ğŸ”’ No security vulnerabilities (e.g., SQL injection, insecure dependencies).
- âš¡ API response time < 200ms (for the initial 202 response).
- ğŸ“š Complete OpenAPI documentation with examples.

Project Structure (Monorepo Example)
```
loan-prequal-system/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ prequal-api/      # FastAPI service
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py     # FastAPI app, routers
â”‚   â”‚   â”‚   â”œâ”€â”€ logic.py    # Business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ models.py   # Pydantic models
â”‚   â”‚   â”‚   â”œâ”€â”€ db.py       # DB models & session
â”‚   â”‚   â”‚   â””â”€â”€ producer.py # Kafka producer
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ pyproject.toml
â”‚   â”‚
â”‚   â”œâ”€â”€ credit-service/   # Kafka consumer service
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py     # Consumer loop
â”‚   â”‚   â”‚   â””â”€â”€ logic.py    # CIBIL sim logic
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ pyproject.toml
â”‚   â”‚
â”‚   â””â”€â”€ decision-service/ # Kafka consumer service
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ main.py     # Consumer loop
â”‚       â”‚   â”œâ”€â”€ logic.py    # Decision engine logic
â”‚       â”‚   â””â”€â”€ db.py       # DB update logic
â”‚       â”œâ”€â”€ tests/
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â””â”€â”€ pyproject.toml
â”‚
â”œâ”€â”€ .pre-commit-config.yaml
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

## Development Guidelines

### Code Standards

1. **Follow Clean Code principles.**
2. **Follow PEP 8.**
3. **Use meaningful variable and method names.**
4. **Keep functions small and focused.**
5. **Write self-documenting code.**
6. **Documentation Requirements**
7. **OpenAPI 3.0: Ensure FastAPI docstrings and Pydantic models generate clear examples.**
8. **Docstrings: For all public modules, classes, and functions (e.g., Google, NumPy style).**
9. **README: Detailed setup, configuration, and make commands.**

### Expected Deliverables

Generate complete implementation including:

- [x] All 3 microservices (prequal-api, credit-service, decision-service).
- [x] Comprehensive test suite (pytest unit, API, and integration tests).
- [x] Error handling (Global exception handling in FastAPI, consumer error logic).
- [x] Documentation (Auto-generated OpenAPI, Docstrings, README).
- [x] Configuration (docker-compose.yml, .env files for settings).
- [x] Quality assurance (Passing pre-commit hooks for Ruff and Black).

---

## Implementation Progress Tracker

### Phase 1-4: Core Implementation âœ… COMPLETED
**Completed**: All microservices implemented with full business logic
- âœ… prequal-api (FastAPI) with POST /applications and GET /applications/{id}/status
- âœ… credit-service (Kafka consumer) with CIBIL score simulation
- âœ… decision-service (Kafka consumer) with decision engine
- âœ… PostgreSQL database with optimistic locking
- âœ… Kafka message flow with transactional outbox pattern
- âœ… Encryption service for PAN data (AES-256-GCM)
- âœ… docker-compose setup for all services

### Phase 5: Testing Infrastructure âœ… COMPLETED
**Completed**: Unit tests for all business logic (48 tests passing)
- âœ… Encryption service tests: 13/13 tests (94% coverage)
- âœ… Credit service tests: 17/17 tests (100% coverage)
- âœ… Decision service tests: 18/18 tests (100% coverage)

### Phase 6: CI/CD Pipeline âœ… COMPLETED
**Completed**: GitHub Actions workflow with pre-commit hooks
- âœ… Fixed Docker Compose v2 syntax (docker compose)
- âœ… Fixed 129 Ruff linting errors across all services
- âœ… Fixed pytest module collision issues
- âœ… Pre-commit hooks configured and working (Ruff, Black, YAML validation)
- âœ… All CI/CD workflow jobs passing

### Phase 7: API Integration Tests âœ… COMPLETED
**Completed**: API validation tests for prequal-api (9/9 passing)
- âœ… Created test_api_simple.py with comprehensive Pydantic model validation
  - âœ… PAN format validation (valid/invalid formats)
  - âœ… Age validation (underage applicants rejected)
  - âœ… Email and phone number validation
  - âœ… Amount validation (zero, negative, max limit)
  - âœ… Missing required fields validation
  - âœ… Response model creation tests
  - âœ… ErrorCode enum validation
- âœ… Created conftest.py with reusable test fixtures
- âœ… Fixed import issues by adding services/__init__.py
- âœ… All 56 tests passing (encryption: 13, credit: 17, decision: 18, API: 9)
- ğŸ“ Note: Full endpoint tests with FastAPI TestClient deferred to E2E phase due to complexity of mocking FastAPI app initialization with lifespan events, database, and Kafka dependencies

### Phase 8: E2E Tests â³ PENDING
**Not Started**: End-to-end workflow tests
- â³ Test complete workflow: Submit â†’ Poll â†’ Verify decision
- â³ Test PRE_APPROVED scenario
- â³ Test REJECTED scenario
- â³ Test MANUAL_REVIEW scenario
- â³ Test with docker-compose running

### Phase 9: Kafka Integration Tests â³ PENDING
**Not Started**: Integration tests for message flow
- â³ Test prequal-api â†’ Kafka â†’ credit-service
- â³ Test credit-service â†’ Kafka â†’ decision-service
- â³ Test database updates through the flow
- â³ Test idempotency and retry logic

### Phase 10: Local Testing & Documentation â³ PENDING
**Not Started**: Final verification and documentation
- â³ Verify docker-compose setup locally
- â³ Create .env.example files for each service
- â³ Update API docstrings with more examples
- â³ Test all services running together

---
**Note**: All implementations must follow enterprise-grade standards and be production-ready.
